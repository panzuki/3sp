<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物質の変遷フロー</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        svg {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            transition: r 0.2s ease-in-out, fill 0.2s ease-in-out;
        }
        .node:hover circle {
            fill: #3b82f6;
            r: 8px; /* ホバーで少し大きく */
        }
        .link {
            fill: none;
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
        }
        .node text {
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        .group-label {
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
            fill: #555;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>パン生地の物質変遷図</h1>
    <svg id="chart"></svg>
    <div class="tooltip"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const width = 1200;
        const height = 900;
        const radius = Math.min(width, height) / 2 - 50;

        const svg = d3.select("#chart")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip");

        const files = ["csv/chart1.csv", "csv/chart2.csv", "csv/chart3.csv"];
        const groupColors = {
            'chart1': '#a8e6cf', // 原材料
            'chart2': '#ff8b94', // 化学反応
            'chart3': '#dcedc1'  // 最終物質
        };

        // 3つのCSVファイルを並行して読み込む
        Promise.all(files.map(url => d3.csv(url))).then(datasets => {
            const chart1Data = datasets[0];
            const chart2Data = datasets[1];
            const chart3Data = datasets[2];

            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            // chart1（原材料）のノードを生成
            chart1Data.forEach(d => {
                const id = `C1-${d.番号}`;
                const node = { id, name: d.物質名, group: 'chart1' };
                nodes.push(node);
                nodeMap.set(d.番号, node);
            });

            // chart2（化学反応）のノードを生成
            chart2Data.forEach(d => {
                const id = `C2-${d.番号}`;
                const node = { id, name: d.反応名, group: 'chart2' };
                nodes.push(node);
                nodeMap.set(d.番号, node);
            });

            // chart3（最終物質）のノードを生成し、リンクを解析
            chart3Data.forEach(d => {
                const id = `C3-${d.番号}`;
                const node = { id, name: d.構成物質名, group: 'chart3' };
                nodes.push(node);
                nodeMap.set(d.番号, node);

                if (d.引き継ぎ番号) {
                    const cleanText = d.引き継ぎ番号.replace(/^"|"$/g, '');
                    const parts = cleanText.split(/,(?![^()]*\))/g).map(p => p.trim());

                    parts.forEach(part => {
                        const reactionMatch = part.match(/([+\-]?)(M\d+|R\d+)(?:\((.*?)\))?/);
                        if (reactionMatch) {
                            const reactionId = reactionMatch[2];
                            const sourceMaterials = reactionMatch[3] ? reactionMatch[3].split(',').map(s => s.trim()) : [];

                            sourceMaterials.forEach(matId => {
                                const sourceNode = nodeMap.get(matId);
                                const reactionNode = nodeMap.get(reactionId);
                                if (sourceNode && reactionNode) {
                                    links.push({ source: sourceNode.id, target: reactionNode.id });
                                }
                            });
                            
                            // 化学反応から最終物質へのリンク
                            const reactionNode = nodeMap.get(reactionId);
                            if (reactionNode) {
                                links.push({ source: reactionNode.id, target: node.id });
                            }

                        } else {
                            // 化学反応を経由しない直接的な引き継ぎ
                            const sourceNode = nodeMap.get(part);
                            if (sourceNode) {
                                links.push({ source: sourceNode.id, target: node.id });
                            }
                        }
                    });
                }
            });

            // ノードのグループごとの配置
            const nodeGroupData = d3.groups(nodes, d => d.group);

            const groupAngles = {
                'chart1': -Math.PI / 2, // 12時
                'chart2': Math.PI / 6, // 3時
                'chart3': 2 * Math.PI / 3 // 8時
            };

            nodeGroupData.forEach(([group, groupNodes]) => {
                const startAngle = groupAngles[group];
                const angleStep = 2 * Math.PI / groupNodes.length / 4; // 間隔を調整
                
                groupNodes.forEach((node, i) => {
                    const angle = startAngle + i * angleStep;
                    node.x = radius * Math.cos(angle);
                    node.y = radius * Math.sin(angle);
                });
            });

            // リンクの描画
            const link = svg.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => {
                    const sourceNode = nodes.find(n => n.id === d.source);
                    const targetNode = nodes.find(n => n.id === d.target);
                    return `M${sourceNode.x},${sourceNode.y} L${targetNode.x},${targetNode.y}`;
                });

            // ノードの描画
            const node = svg.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            node.append("circle")
                .attr("r", 5)
                .attr("fill", d => groupColors[d.group])
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.name}</strong><br>${d.id}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 20) + "px");
                })
                .on("mouseout", () => {
                    tooltip.style("opacity", 0);
                });

            node.append("text")
                .attr("dy", -10)
                .text(d => d.name);

            // グループラベルの描画
            const groupLabels = [
                { name: 'Chart 1: 原材料', group: 'chart1', x: -radius - 50, y: 0 },
                { name: 'Chart 2: 化学反応', group: 'chart2', x: radius / 2, y: -radius * 1.2 },
                { name: 'Chart 3: 最終物質', group: 'chart3', x: radius / 2, y: radius * 1.2 }
            ];

            svg.selectAll(".group-label")
                .data(groupLabels)
                .enter().append("text")
                .attr("class", "group-label")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .text(d => d.name);
        }).catch(error => {
            console.error("CSVファイルの読み込み中にエラーが発生しました。", error);
        });
    </script>
</body>
</html>
