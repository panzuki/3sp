<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Wheat History Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; background-color: #f0f0f0; }
        #controls { position: absolute; top: 10px; right: 10px; background: white; padding: 10px; }
        .marker { fill: red; cursor: pointer; }
        .line { stroke: #888; stroke-width: 2px; marker-end: url(#arrow); }
        .popup { background: white; padding: 5px; border-radius: 5px; position: absolute; pointer-events: none; font-size: 12px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="controls">
    <button onclick="prevMarker()">〈 Previous</button>
    <button onclick="nextMarker()">Next 〉</button>
</div>

<script>
    const locations = [
        { latlng: [33.5, 44.4], popup: "Fertile Crescent (10,000 BC) - Origin of Wheat Cultivation", nextp: [1, 5, 6] },
        { latlng: [31.0461, 34.8516], popup: "Egypt (5000 BC) - Bread Becomes Staple Food", nextp: [2] },
        { latlng: [37.9838, 23.7275], popup: "Greece (3000 BC) - Wheat Spreads to the Mediterranean", nextp: [3] },
        { latlng: [41.9028, 12.4964], popup: "Rome (1000 BC) - Public Bakeries in the Roman Empire", nextp: [4] },
        { latlng: [48.8566, 2.3522], popup: "France (500 AD) - Wheat Cultivation and Bread Making Flourish", nextp: ["none"] },
        { latlng: [51.5074, -0.1278], popup: "United Kingdom (1000 AD) - Bread as a Staple for All Classes", nextp: ["none"] },
        { latlng: [40.7128, -74.0060], popup: "United States (1700 AD) - Wheat Cultivation Expands to the New World", nextp: ["none"] }
    ];

    let currentIndex = 0;

    // D3.js map projection settings
    const width = document.getElementById('map').offsetWidth;
    const height = document.getElementById('map').offsetHeight;
    const projection = d3.geoMercator().center([20, 40]).scale(150).translate([width / 2, height / 2]);
    const path = d3.geoPath().projection(projection);

    const svg = d3.select("#map").append("svg").attr("width", width).attr("height", height);

    // Arrow definition for line markers
    svg.append("defs").append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 10)
        .attr("refY", 0)
        .attr("markerWidth", 4)
        .attr("markerHeight", 4)
        .attr("orient", "auto")
      .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", "#888");

    // Draw initial markers
    const markers = svg.selectAll(".marker")
        .data(locations)
        .enter()
        .append("circle")
        .attr("class", "marker")
        .attr("r", 5)
        .attr("cx", d => projection(d.latlng)[0])
        .attr("cy", d => projection(d.latlng)[1])
        .on("click", (event, d) => showPopup(d));

    // Show initial popup
    const popup = d3.select("body").append("div").attr("class", "popup").style("display", "none");
    showPopup(locations[currentIndex]);

    function showPopup(location) {
        popup.style("display", "block")
            .html(location.popup)
            .style("left", `${projection(location.latlng)[0] + 10}px`)
            .style("top", `${projection(location.latlng)[1] - 10}px`);
    }

    function drawConnections(index) {
        clearLines();
        popup.style("display", "none");

        const currentLocation = locations[index];
        currentLocation.nextp.forEach(nextIndex => {
            if (nextIndex !== "none") {
                const destination = locations[nextIndex];

                svg.append("line")
                    .attr("class", "line")
                    .attr("x1", projection(currentLocation.latlng)[0])
                    .attr("y1", projection(currentLocation.latlng)[1])
                    .attr("x2", projection(destination.latlng)[0])
                    .attr("y2", projection(destination.latlng)[1]);

                showPopup(destination);
            }
        });
    }

    function clearLines() {
        svg.selectAll(".line").remove();
    }

    function nextMarker() {
        if (currentIndex < locations.length - 1) {
            currentIndex++;
            drawConnections(currentIndex);
        }
    }

    function prevMarker() {
        if (currentIndex > 0) {
            currentIndex--;
            drawConnections(currentIndex);
        }
    }
</script>
</body>
</html>
