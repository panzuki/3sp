<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タイムライン表示</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>


  <style>
    /* スクロール可能なコンテナ */
    .container {
      overflow-x: auto;
      overflow-y: auto;
      width: 100%;
      height: 500px;
      display: block;
    }
    /* ヘッダー */
    .header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
    }
    /* 各グラフ行 */
    .chart-row {
      display: flex;
      justify-content: space-between;
      height: 50px;
      align-items: center;
    }
    /* 出来事行 */
    .event-row {
      display: flex;
      justify-content: space-between;
      background-color: #f0f0f0;
      align-items: center;
      height: 50px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="timelineContainer">
      <!-- タイムラインとグラフがここに追加される -->
    </div>
  </div>

  <script>
    // CSVを読み込んでJSONに変換する
    function loadCSV() {
      // Timeline.csvの読み込み
Papa.parse("csv/Timeline.csv", {
  download: true,
  header: true,
  dynamicTyping: true,
  skipEmptyLines: true,
  complete: function(results) {
    if (results.errors.length > 0) {
      console.error("Timeline.csvの読み込みエラー:", results.errors);
      results.errors.forEach(error => {
        console.error(`エラー詳細: 行番号 ${error.row}, メッセージ: ${error.message}`);
      });
      return;
    }
    const timelineData = results.data;
    const jsonTimelineData = parseTimelineData(timelineData);

    // 次のCSV読み込み
    Papa.parse("csv/Events.csv", {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function(eventResults) {
        if (eventResults.errors.length > 0) {
          console.error("Events.csvの読み込みエラー:", eventResults.errors);
          results.errors.forEach(error => {
            console.error(`エラー詳細: 行番号 ${error.row}, メッセージ: ${error.message}`);
          });
          return;
        }
        const eventData = eventResults.data;
        const jsonEventData = parseEventData(eventData);

        renderTimeline(jsonTimelineData, jsonEventData);
      }
    });
  }
});

    }

// Timelineデータを解析
function renderTimeline(timelineData, eventData) {
  const timelineContainer = document.getElementById("timelineContainer");
  const { timeline } = timelineData;

  timeline.forEach(item => {
    // 年代表示
    const periodRow = document.createElement("div");
    periodRow.textContent = item.period;
    periodRow.style.fontWeight = "bold";
    periodRow.style.marginTop = "20px";
    timelineContainer.appendChild(periodRow);

    // 積み上げグラフ: 国
    const chartRow = document.createElement("div");
    chartRow.className = "chart-row";
    const chartCell = document.createElement("canvas");
    chartCell.style.height = "100px"; // グラフの高さを増やす
    chartRow.appendChild(chartCell);

    // 各王国の積み上げグラフ
    new Chart(chartCell, {
      type: 'bar',
      data: {
        labels: [item.period],
        datasets: Object.keys(item.states).flatMap(region =>
          item.states[region].map(state => ({
            label: state.name, // 王国名（凡例に使用せず、グラフ内に表示）
            data: [state.share], // シェア
            backgroundColor: state.color, // 色
            borderColor: 'black',
            borderWidth: 1
          }))
        )
      },
      options: {
        indexAxis: 'y', // 横棒グラフ
        plugins: {
          legend: { display: false }, // 凡例を非表示
          tooltip: { enabled: false } // ツールチップを非表示
        },
        responsive: true,
        maintainAspectRatio: false, // 高さ調整
        scales: {
          x: { display: false }, // x軸の目盛りを非表示
          y: { display: false }  // y軸の目盛りを非表示
        },
        elements: {
          bar: {
            borderSkipped: false, // ボーダーを完全表示
            datalabels: {
              anchor: 'center',
              align: 'center',
              color: 'black',
              formatter: (value, context) => context.dataset.label // グラフ内に王国名を表示
            }
          }
        },
        layout: {
          padding: { top: 10, bottom: 10 } // グラフ内の余白調整
        }
      }
    });

    timelineContainer.appendChild(chartRow);

    // 出来事グラフ: 出来事
    const eventRow = document.createElement("div");
    eventRow.className = "chart-row";
    const eventCell = document.createElement("canvas");
    eventCell.style.height = "100px"; // 出来事グラフの高さを増やす
    eventRow.appendChild(eventCell);

    const eventDataset = eventData
      .filter(event => event.period === item.period)
      .map(event => ({
        label: event.title, // 出来事のタイトル
        data: [1], // 固定値（全て1で表示）
        backgroundColor: 'lightblue', // 出来事の背景色
        borderColor: 'black',
        borderWidth: 1
      }));

    if (eventDataset.length > 0) {
      new Chart(eventCell, {
        type: 'bar',
        data: {
          labels: [item.period],
          datasets: eventDataset
        },
        options: {
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: false },
            y: { display: false }
          },
          elements: {
            bar: {
              borderSkipped: false,
              datalabels: {
                anchor: 'center',
                align: 'center',
                color: 'black',
                formatter: (value, context) => context.dataset.label // グラフ内に出来事のタイトルを表示
              }
            }
          },
          layout: {
            padding: { top: 10, bottom: 10 }
          }
        }
      });
    } else {
      eventCell.textContent = "出来事なし"; // 出来事がない場合の表示
    }

    timelineContainer.appendChild(eventRow);
  });
}




    // ページ読み込み時にCSVをロード
    window.onload = loadCSV;
  </script>

</body>
</html>
