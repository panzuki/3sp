<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タイムライン表示</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>


  <style>
    /* スクロール可能なコンテナ */
    .container {
      overflow-x: auto;
      overflow-y: auto;
      width: 100%;
      height: 500px;
      display: block;
    }
    /* ヘッダー */
    .header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
    }
    /* 各グラフ行 */
    .chart-row {
      display: flex;
      justify-content: space-between;
      height: 50px;
      align-items: center;
    }
    /* 出来事行 */
    .event-row {
      display: flex;
      justify-content: space-between;
      background-color: #f0f0f0;
      align-items: center;
      height: 50px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="timelineContainer">
      <!-- タイムラインとグラフがここに追加される -->
    </div>
  </div>

  <script>
    // CSVを読み込んでJSONに変換する
    function loadCSV() {
      // Timeline.csvの読み込み
Papa.parse("https://github.com/panzuki/3sp/csv/Timeline.csv", {
  download: true,
  header: true,
  dynamicTyping: true,
  complete: function(results) {
    if (results.errors.length > 0) {
      console.error("Timeline.csvの読み込みエラー:", results.errors);
      return;
    }
    const timelineData = results.data;
    const jsonTimelineData = parseTimelineData(timelineData);

    // 次のCSV読み込み
    Papa.parse("https://github.com/panzuki/3sp/csv/Events.csv", {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(eventResults) {
        if (eventResults.errors.length > 0) {
          console.error("Events.csvの読み込みエラー:", eventResults.errors);
          return;
        }
        const eventData = eventResults.data;
        const jsonEventData = parseEventData(eventData);

        renderTimeline(jsonTimelineData, jsonEventData);
      }
    });
  }
});

    }

// Timelineデータを解析
function parseTimelineData(timelineData) {
  const timeline = [];
  const regions = new Set();

  timelineData.forEach(item => {
    const period = item.Period;
    const region = item.Region;
    const state = item.State;
    const share = item.Share;
    const color = item.Color;
    
    // Coordinatesを確認し、空ならスキップ
    let coordinates = [];
    if (item.Coordinates) {
      try {
        coordinates = JSON.parse(item.Coordinates);
      } catch (e) {
        console.error("Invalid JSON in Coordinates:", item.Coordinates, e);
        return; // 次のデータに進む
      }
    }

    // 地域をセットに追加してユニーク化
    regions.add(region);

    // タイムラインにデータをまとめる
    const periodData = timeline.find(p => p.period === period);
    if (periodData) {
      const regionData = periodData.states[region] || [];
      regionData.push({ name: state, share, color, coordinates });
      periodData.states[region] = regionData;
    } else {
      timeline.push({
        period,
        states: {
          [region]: [{ name: state, share, color, coordinates }]
        }
      });
    }
  });

  return { timeline, regions: Array.from(regions) };
}


    // Eventsデータを解析
    function parseEventData(eventData) {
      const events = [];

      eventData.forEach(item => {
        const period = item.Period;
        const region = item.Region;
        const state = item.State;
        const title = item.Title;
        const details = item.Details;
        const image = item.Image;
        const coordinates = item.Coordinates.split(",").map(val => parseFloat(val.trim()));

        events.push({ period, region, state, title, details, image, coordinates });
      });

      return events;
    }

    // タイムラインの描画
    function renderTimeline(timelineData, eventData) {
      const timelineContainer = document.getElementById("timelineContainer");
      const { timeline, regions } = timelineData;

      // ヘッダー作成
      const headerRow = document.createElement("div");
      headerRow.className = "header";

      // ヘッダーに地域を追加
      ["空白", ...regions].forEach(region => {
        const headerCell = document.createElement("div");
        headerCell.textContent = region;
        headerRow.appendChild(headerCell);
      });
      timelineContainer.appendChild(headerRow);

      timeline.forEach(item => {
        // 国家行を描画
        Object.keys(item.states).forEach(region => {
          const chartRow = document.createElement("div");
          chartRow.className = "chart-row";
          
          item.states[region].forEach(state => {
            const chartCell = document.createElement("canvas");
            chartRow.appendChild(chartCell);

            // Chart.js 横棒グラフの作成
            new Chart(chartCell, {
              type: 'bar',
              data: {
                labels: [state.name],
                datasets: [{
                  data: [state.share],
                  backgroundColor: state.color,
                  borderColor: 'black',
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  x: { beginAtZero: true }
                }
              }
            });
          });
          timelineContainer.appendChild(chartRow);

          // 出来事行を描画
          const eventRow = document.createElement("div");
          eventRow.className = "event-row";
          
          eventData.filter(event => event.period === item.period && event.region === region).forEach(event => {
            const eventCell = document.createElement("div");
            eventCell.textContent = event.title;
            eventRow.appendChild(eventCell);
          });
          timelineContainer.appendChild(eventRow);
        });
      });
    }

    // ページ読み込み時にCSVをロード
    window.onload = loadCSV;
  </script>

</body>
</html>
