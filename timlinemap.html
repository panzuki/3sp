<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タイムライン表示</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>



  <style>
    /* スクロール可能なコンテナ */
    .container {
      overflow-x: auto;
      overflow-y: auto;
      width: 100%;
      height: 500px;
      display: block;
    }
    /* ヘッダー */
    .header {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
    }
    /* 各グラフ行 */
.chart-row {
  display: flex; /* 必要に応じて他の子要素に対応 */
  align-items: center; /* 子要素を中央揃え */
  justify-content: center;
  height: 150px; /* 必要な高さを設定 */
  width: 100%; /* 横幅を親要素に合わせる */
  position: relative; /* 必要なら設定 */
  overflow: hidden; /* 描画がはみ出さないように調整 */
}

    /* 出来事行 */
    .event-row {
      display: flex;
      justify-content: space-between;
      background-color: #f0f0f0;
      align-items: center;
      height: 50px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="timelineContainer">
      <!-- タイムラインとグラフがここに追加される -->
    </div>
  </div>

  <script>
function loadCSV() {
  Papa.parse("csv/Timeline.csv", {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function(results) {
      if (results.errors.length > 0) {
        console.error("Timeline.csvの読み込みエラー:", results.errors);
        results.errors.forEach(error => {
          console.error(`エラー詳細: 行番号 ${error.row}, メッセージ: ${error.message}`);
        });
        return;
      }

      const timelineData = results.data;
      const jsonTimelineData = parseTimelineData(timelineData);
      renderTimeline(jsonTimelineData);
    }
  });
}

// Timelineデータを解析
function parseTimelineData(timelineData) {
  const timeline = [];
  const regions = new Set();
  timelineData.forEach(item => {
    const period = item.Period || "未定義";
    const region = item.Region || "未定義";
    const state = item.State || "未定義";
    const share = item.Share || 0;
    const color = item.Color || "gray";
    let coordinates = [];
    try {
      if (item.Coordinates) {
        // 正規表現で座標のペアを抽出して解析
        coordinates = item.Coordinates
          .match(/\[\[([^\]]+)\]\]/g)
          .map(coord => {
            return coord.replace(/\[|\]/g, '').split(',').map(Number);
          });
      }
    } catch (e) {
      console.error("Coordinates解析エラー:", e);
    }

    // 地域をセットに追加してユニーク化
    regions.add(region);

    // タイムラインにデータをまとめる
    const periodData = timeline.find(p => p.period === period);
    if (periodData) {
      const regionData = periodData.states[region] || [];
      regionData.push({ name: state, share, color, coordinates });
      periodData.states[region] = regionData;
    } else {
      timeline.push({
        period,
        states: {
          [region]: [{ name: state, share, color, coordinates }]
        }
      });
    }
  });
  return { timeline, regions: Array.from(regions) };
}

// タイムラインをレンダリング
function renderTimeline(timelineData) {
  Chart.register(ChartDataLabels);
  const timelineContainer = document.getElementById("timelineContainer");
  const { timeline, regions } = timelineData;

  // ヘッダー行の作成
  const headerRow = document.createElement("div");
  headerRow.className = "header";
  headerRow.style.display = "flex";

  ["空白", ...regions].forEach(region => {
    const headerCell = document.createElement("div");
    headerCell.textContent = region;
    headerCell.style.flex = "1";
    headerCell.style.textAlign = "center";
    headerCell.style.fontWeight = "bold";
    headerCell.style.borderBottom = "2px solid black";
    headerRow.appendChild(headerCell);
  });
  timelineContainer.appendChild(headerRow);

  // タイムラインデータを順番に処理
  timeline.forEach(item => {
    const chartRow = document.createElement("div");
    chartRow.className = "chart-row";

    // グラフの表示
    const chartCell = document.createElement("canvas");
    chartCell.style.height = "200px";
    chartRow.appendChild(chartCell);
    timelineContainer.appendChild(chartRow);



    new Chart(chartCell, {
      type: 'bar',
      data: {
        labels: [item.period],
        datasets: Object.keys(item.states).flatMap(region =>
          item.states[region].map(state => ({
        //datasets: Object.values(mergedStates).map(state => ({
          label: state.name,
          data: [state.share],
          backgroundColor: state.color,
          borderColor: 'black',
          borderWidth: 1
        }))
        )
      },
      options: {
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false },
          datalabels: {
            color: 'white',
            align: 'center',
            anchor: 'center',
            formatter: (value, context) => context.dataset.label,
            font: { weight: 'bold', size: 12 }
          },
        },
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { display: false, stacked: true },
          y: { display: true, stacked: true }
        }
      }
    });
  });
}

window.onload = loadCSV;


  </script>

</body>
</html>
